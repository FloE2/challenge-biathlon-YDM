<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Challenge Biathlon 3√®me - Yves du Manoir (Simplifi√©)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100">
  
  <div id="app"></div>
 <!-- Firebase SDK -->
 <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
 <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
 
 <script>
  
      const POULES_DATA = {
      A: [
        { name: "√âquipe 6", members: ["MANUELLI Mat√©i", "REICH Lucie", "ATTIA Cl√©o", "LOUIS"] },
        { name: "√âquipe 1", members: ["RACINE Chrisl√®ne", "GOINVIC Matthieu", "DAVIET GOMES PALMA Emma", "NAAR Georgia", "FANTIN"] },
        { name: "√âquipe 12", members: ["KIRCALI Daghan", "REVEYRON Camille", "MOHAMED AHMED Darine", "BELLUS Olivier"] },
        { name: "√âquipe 5", members: ["CHINARDET Jules", "PANTIS Sarah Milenna", "FOUET PREVOT Gabriel", "LETIN Harl√®me"] }
      ],
      B: [
        { name: "√âquipe 14", members: ["DALIA Enzo", "ACHITE-HENNI Arsene", "MANYOTIS C√©line", "HEMAR Nicolas"] },
        { name: "√âquipe 3", members: ["SANSON Stella", "TENNEGUIN Benjamin", "FALANTIN Nata√´l", "FERAUD Cl√©mence"] },
        { name: "√âquipe 16", members: ["SENICO Oscar", "MORILLON Anatole", "MOJICA Jewel", "FORTEAUX Zoe"] },
        { name: "√âquipe 11", members: ["COCHERIL Andy", "jessica", "FERREIRA DE MORAIS Chlo√©", "PALMEIRAO Sol√®ne"] }
      ],
      C: [
        { name: "√âquipe 17", members: ["JACQUET DE BROSSARD William", "PATIN Jade", "THOMAS", "DAVID Ange"] },
        { name: "√âquipe 9", members: ["HIOBI Alexandre", "PALMEIRAO Eleonore", "DHARMARATNA Shahan", "LEBLANC Jeanne"] },
        { name: "√âquipe 7", members: ["NASSEREDDINE Hadi", "PELADE √âlodie", "MADEIRAS L√©andro", "WINNICKI Maximillian"] },
        { name: "√âquipe 2", members: ["MICHEL Iris", "KREISS Julien", "LINTZ-FLUCHERE Manon", "SCHIFFMACHER L√©a"] }
      ],
      D: [
        { name: "√âquipe 8", members: ["SCHWAB Hadrien", "BLOCUS Mah√©e", "ROY DE OLIVEIRA Paul", "SABRY"] },
        { name: "√âquipe 4", members: ["CATHERINOT Estelle", "MANUELLI Pasqual", "GOMOT Axel", "CROIX Line"] },
        { name: "√âquipe 13", members: ["ROGER Robin", "RALINIRINA Mitia", "EYCHENNE Ruben", "ELEANA"] },
        { name: "√âquipe 15", members: ["FORTIER-BEAULIEU Antoine", "SANGLIER Mathilde", "LURBE BRIEST Evan", "NANEGNON Chance"] }
      ]
    };

    const SCHEDULE = [
      { time: "8h15 - 9h15", event: "Installation et √©chauffements (Tir + Course)" },
      { time: "9h15 - 9h30", event: "ROUND 1 - Poules A + B (5min test carabines avant)", poules: ["A", "B"], type: "qualif" },
      { time: "9h30 - 9h45", event: "ROUND 2 - Poules C + D (5min test carabines avant)", poules: ["C", "D"], type: "qualif" },
      { time: "9h45 - 10h00", event: "ROUND 3 - Poules A + B", poules: ["A", "B"], type: "qualif" },
      { time: "10h00 - 10h15", event: "ROUND 4 - Poules C + D", poules: ["C", "D"], type: "qualif" },
      { time: "10h15 - 10h45", event: "Calcul des classements" },
      { time: "10h45 - 11h15", event: "FINALE UNIQUE - 8 √©quipes Principal + 8 √©quipes Consolante (simultan√©)", type: "finale" }
    ];
    
    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyADUKP5x5gROlfJn-C3NtHGs11jcnKzwvM",
      authDomain: "challenge-biathlon-ydm.firebaseapp.com",
      databaseURL: "https://challenge-biathlon-ydm-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "challenge-biathlon-ydm",
      storageBucket: "challenge-biathlon-ydm.firebasestorage.app",
      messagingSenderId: "643606362572",
      appId: "1:643606362572:web:8c376e8dc9f2b4b3ba0569"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    function updateFirebaseStatus(status, message) {
      const statusDiv = document.getElementById('firebase-status');
      const icon = document.getElementById('status-icon');
      const text = document.getElementById('status-text');
      
      if (!statusDiv || !icon || !text) return;
      
      if (status === 'connected') {
        statusDiv.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-green-500 text-white';
        icon.textContent = '‚úì';
      } else if (status === 'syncing') {
        statusDiv.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-orange-500 text-white';
        icon.textContent = 'üîÑ';
      } else {
        statusDiv.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-red-500 text-white';
        icon.textContent = '‚ö†Ô∏è';
      }
      text.textContent = message;
    }
    
    
    class BiathonApp {
      constructor() {
        this.activeTab = 'planning';
        this.poulesData = POULES_DATA;
        this.results = {};
        this.settings = { minPercentage: 50, penaltyTime: 60 };
        this.initAsync();
      }

      async loadSettings() {
        try {
          const snapshot = await database.ref('biathlon-data/settings').once('value');
          if (snapshot.exists()) {
            return snapshot.val();
          }
        } catch (error) {
          console.error('Erreur chargement param√®tres:', error);
        }
        return {
          minPercentage: 50,
          penaltyTime: 60
        };
      }

      async saveSettings() {
        try {
          updateFirebaseStatus('syncing', 'Synchronisation...');
          await database.ref('biathlon-data/settings').set(this.settings);
          updateFirebaseStatus('connected', 'Connect√© ‚úì');
        } catch (error) {
          console.error('Erreur sauvegarde param√®tres:', error);
          updateFirebaseStatus('error', 'Erreur');
        }
      }

      updateSetting(key, value) {
        this.settings[key] = parseFloat(value);
        this.saveSettings();
        this.render();
      }

      async loadPoulesData() {
        try {
          const snapshot = await database.ref('biathlon-data/poules').once('value');
          if (snapshot.exists()) {
            return snapshot.val();
          }
        } catch (error) {
          console.error('Erreur chargement poules:', error);
        }
        return POULES_DATA;
      }

      async savePoulesData() {
        try {
          updateFirebaseStatus('syncing', 'Synchronisation...');
          await database.ref('biathlon-data/poules').set(this.poulesData);
          await database.ref('biathlon-data/lastUpdate').set(new Date().toISOString());
          updateFirebaseStatus('connected', 'Connect√© ‚úì');
        } catch (error) {
          console.error('Erreur sauvegarde poules:', error);
          updateFirebaseStatus('error', 'Erreur');
        }
      }

      resetPoulesData() {
        if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser toutes les √©quipes aux valeurs par d√©faut ?')) {
          this.poulesData = JSON.parse(JSON.stringify(POULES_DATA));
          this.savePoulesData();
          this.render();
        }
      }

      addMemberToTeam(poule, teamIndex, memberName) {
        if (memberName && memberName.trim()) {
          this.poulesData[poule][teamIndex].members.push(memberName.trim());
          this.savePoulesData();
          this.render();
        }
      }

      removeMemberFromTeam(poule, teamIndex, memberIndex) {
        if (confirm('√ätes-vous s√ªr de vouloir retirer cet √©l√®ve ?')) {
          this.poulesData[poule][teamIndex].members.splice(memberIndex, 1);
          this.savePoulesData();
          this.render();
        }
      }

      removeTeam(poule, teamIndex) {
        const team = this.poulesData[poule][teamIndex];
        if (confirm('√ätes-vous s√ªr de vouloir supprimer l\'√©quipe ' + team.name + ' ?')) {
          this.poulesData[poule].splice(teamIndex, 1);
          this.savePoulesData();
          this.render();
        }
      }

      moveTeam(fromPoule, teamIndex, toPoule) {
        if (fromPoule === toPoule) return;
        const team = this.poulesData[fromPoule][teamIndex];
        if (confirm('D√©placer ' + team.name + ' de la Poule ' + fromPoule + ' vers la Poule ' + toPoule + ' ?')) {
          this.poulesData[fromPoule].splice(teamIndex, 1);
          this.poulesData[toPoule].push(team);
          this.savePoulesData();
          this.render();
        }
      }

      renameTeam(poule, teamIndex, newName) {
        if (newName && newName.trim()) {
          this.poulesData[poule][teamIndex].name = newName.trim();
          this.savePoulesData();
          this.render();
        }
      }

      addTeam(poule) {
        const teamName = prompt('Nom de la nouvelle √©quipe :');
        if (teamName && teamName.trim()) {
          this.poulesData[poule].push({
            name: teamName.trim(),
            members: []
          });
          this.savePoulesData();
          this.render();
        }
      }

      formatTime(seconds) {
        if (!seconds || seconds === 0) return '-';
        const mins = Math.floor(seconds / 60);
        const secs = (seconds % 60).toFixed(2);
        return mins + ':' + secs.padStart(5, '0');
      }

      formatPenalty(seconds) {
        if (!seconds || seconds === 0) return '';
        const mins = Math.floor(seconds / 60);
        if (mins === 1) return '+1 min';
        if (mins > 1) return '+' + mins + ' min';
        return '+' + seconds + 's';
      }

      parseTime(timeStr) {
        if (!timeStr) return 0;
        if (!isNaN(timeStr)) return parseFloat(timeStr);
        const parts = String(timeStr).split(':');
        if (parts.length === 2) {
          return parseFloat(parts[0]) * 60 + parseFloat(parts[1]);
        }
        return 0;
      }

      async loadResults() {
        try {
          const snapshot = await database.ref('biathlon-data/results').once('value');
          return snapshot.exists() ? snapshot.val() : {};
        } catch (error) {
          console.error('Erreur chargement r√©sultats:', error);
          return {};
        }
      }

      async saveResults() {
        try {
          updateFirebaseStatus('syncing', 'Synchronisation...');
          await database.ref('biathlon-data/results').set(this.results);
          await database.ref('biathlon-data/lastUpdate').set(new Date().toISOString());
          updateFirebaseStatus('connected', 'Connect√© ‚úì');
        } catch (error) {
          console.error('Erreur sauvegarde r√©sultats:', error);
          updateFirebaseStatus('error', 'Erreur');
        }
      }

      updateResult(poule, teamName, round, field, value) {
        const key = poule + '-' + teamName;
        if (!this.results[key]) this.results[key] = {};
        this.results[key]['round' + round + '_' + field] = value;
        this.saveResults();
        this.render();
      }

      getTeamResult(poule, teamName) {
        const key = poule + '-' + teamName;
        return this.results[key] || {};
      }

      calculateRoundPercentage(result, round) {
        const blanc = parseInt(result['round' + round + '_blanc'] || 0);
        const jaune = parseInt(result['round' + round + '_jaune'] || 0);
        const maxTirs = parseInt(result['round' + round + '_maxtirs'] || 20);
        const total = blanc + jaune;
        const maxTotal = maxTirs * 2;
        return maxTotal > 0 ? (total / maxTotal) * 100 : 0;
      }

      calculateRoundPenalty(result, round) {
        const percentage = this.calculateRoundPercentage(result, round);
        return percentage < this.settings.minPercentage ? this.settings.penaltyTime : 0;
      }

      calculateAdjustedRoundTime(result, round) {
        const baseTime = this.parseTime(result['round' + round + '_time'] || 0);
        const penalty = this.calculateRoundPenalty(result, round);
        return baseTime + penalty;
      }

      calculateTotalTime(poule, teamName) {
        const result = this.getTeamResult(poule, teamName);
        const round1 = this.calculateAdjustedRoundTime(result, 1);
        const round2 = this.calculateAdjustedRoundTime(result, 2);
        return round1 + round2;
      }

      calculateAveragePercentage(poule, teamName) {
        const result = this.getTeamResult(poule, teamName);
        const p1 = this.calculateRoundPercentage(result, 1);
        const p2 = this.calculateRoundPercentage(result, 2);
        const count = (p1 > 0 ? 1 : 0) + (p2 > 0 ? 1 : 0);
        return count > 0 ? (p1 + p2) / count : 0;
      }

      getRanking(poule) {
        const self = this;
        return this.poulesData[poule]
          .map(team => {
            return {
              name: team.name,
              members: team.members,
              totalTime: self.calculateTotalTime(poule, team.name),
              avgPercentage: self.calculateAveragePercentage(poule, team.name),
              result: self.getTeamResult(poule, team.name)
            };
          })
          .sort((a, b) => {
            if (a.totalTime === 0 && b.totalTime === 0) return 0;
            if (a.totalTime === 0) return 1;
            if (b.totalTime === 0) return -1;
            return a.totalTime - b.totalTime;
          });
      }

      getQualifiedTeams(type) {
        const allRankings = {
          A: this.getRanking('A'),
          B: this.getRanking('B'),
          C: this.getRanking('C'),
          D: this.getRanking('D')
        };

        const teams = [];
        const poules = Object.keys(allRankings);
        for (let i = 0; i < poules.length; i++) {
          const poule = poules[i];
          const ranking = allRankings[poule];
          for (let j = 0; j < ranking.length; j++) {
            const team = ranking[j];
            const idx = j;
            if (team.totalTime > 0) {
              if (type === 'principal' && (idx === 0 || idx === 1)) {
                teams.push({
                  name: team.name, 
                  members: team.members, 
                  totalTime: team.totalTime, 
                  avgPercentage: team.avgPercentage,
                  poule: poule, 
                  position: idx + 1
                });
              } else if (type === 'consolante' && (idx === 2 || idx === 3)) {
                teams.push({
                  name: team.name, 
                  members: team.members, 
                  totalTime: team.totalTime,
                  avgPercentage: team.avgPercentage,
                  poule: poule, 
                  position: idx + 1
                });
              }
            }
          }
        }
        return teams;
      }

      // NOUVEAU: Gestion simplifi√©e des finales (un seul tour)
      updateFinaleResult(type, teamName, field, value) {
        const key = 'finale_' + type + '_' + teamName + '_' + field;
        this.results[key] = value;
        this.saveResults();
        this.render();
      }

      getFinaleResult(type, teamName, field) {
        const key = 'finale_' + type + '_' + teamName + '_' + field;
        return this.results[key] || '';
      }

      calculateFinalePercentage(type, teamName) {
        const reussis = parseInt(this.getFinaleResult(type, teamName, 'tirs') || 0);
        const maxTirs = parseInt(this.getFinaleResult(type, teamName, 'maxtirs') || 20);
        return maxTirs > 0 ? (reussis / maxTirs) * 100 : 0;
      }

      calculateFinalePenalty(type, teamName) {
        const percentage = this.calculateFinalePercentage(type, teamName);
        return percentage < this.settings.minPercentage ? this.settings.penaltyTime : 0;
      }

      calculateAdjustedFinaleTime(type, teamName) {
        const baseTime = this.parseTime(this.getFinaleResult(type, teamName, 'time') || 0);
        const penalty = this.calculateFinalePenalty(type, teamName);
        return baseTime + penalty;
      }

      getFinaleRanking(type, teams) {
        const self = this;
        const ranking = teams.map(team => {
          const adjustedTime = self.calculateAdjustedFinaleTime(type, team.name);
          const percentage = self.calculateFinalePercentage(type, team.name);
          const penalty = self.calculateFinalePenalty(type, team.name);
          return {
            name: team.name,
            members: team.members,
            adjustedTime: adjustedTime,
            percentage: percentage,
            penalty: penalty
          };
        }).sort((a, b) => {
          if (a.adjustedTime === 0 && b.adjustedTime === 0) return 0;
          if (a.adjustedTime === 0) return 1;
          if (b.adjustedTime === 0) return -1;
          return a.adjustedTime - b.adjustedTime;
        });
        return ranking;
      }

      async clearAllData() {
        if (confirm('√ätes-vous s√ªr de vouloir effacer toutes les donn√©es ?')) {
          try {
            updateFirebaseStatus('syncing', 'Suppression...');
            await database.ref('biathlon-data').remove();
            this.results = {};
            this.poulesData = await this.loadPoulesData();
            this.settings = await this.loadSettings();
            updateFirebaseStatus('connected', 'Connect√© ‚úì');
            this.render();
          } catch (error) {
            console.error('Erreur suppression:', error);
            updateFirebaseStatus('error', 'Erreur');
          }
        }
      }

      renderSettingsBar() {
        return '<div class="bg-blue-100 border-2 border-blue-400 rounded-lg p-4 mb-6">' +
          '<div class="flex items-center gap-6">' +
          '<div class="font-bold text-blue-900">‚öôÔ∏è Param√®tres :</div>' +
          '<div class="flex items-center gap-2">' +
          '<label class="text-sm font-semibold text-blue-900">Pourcentage minimum requis :</label>' +
          '<input type="number" min="0" max="100" step="5" value="' + this.settings.minPercentage + '" ' +
          'onchange="app.updateSetting(\'minPercentage\', this.value)" ' +
          'class="w-20 px-3 py-1 border-2 border-blue-400 rounded font-bold text-center"/>' +
          '<span class="text-blue-900 font-semibold">%</span>' +
          '</div>' +
          '<div class="text-sm text-blue-800">' +
          '‚Üí Si pourcentage < ' + this.settings.minPercentage + '% : <span class="text-red-600 font-bold">+1 minute de p√©nalit√©</span>' +
          '</div>' +
          '</div>' +
          '</div>';
      }

      renderPlanning() {
        let html = '<div class="space-y-4">';
        html += '<div class="flex justify-between items-center mb-6">';
        html += '<h2 class="text-3xl font-bold">Planning du Tournoi</h2>';
        html += '<div class="text-sm text-gray-600">3 F√©vrier 2026 - Challenge Biathlon 3√®me Yves du Manoir</div>';
        html += '</div><div class="space-y-3">';
        
        for (let i = 0; i < SCHEDULE.length; i++) {
          const item = SCHEDULE[i];
          const borderColor = item.type === 'qualif' ? 'border-blue-500 bg-blue-50' :
                             item.type === 'finale' ? 'border-green-500 bg-green-50' :
                             'border-gray-300 bg-gray-50';
          html += '<div class="p-4 rounded-lg border-l-4 ' + borderColor + '">';
          html += '<div class="flex justify-between items-start"><div>';
          html += '<div class="font-bold text-lg">' + item.time + '</div>';
          html += '<div class="text-gray-700 mt-1">' + item.event + '</div></div>';
          if (item.poules) {
            html += '<div class="flex gap-2">';
            for (let j = 0; j < item.poules.length; j++) {
              html += '<span class="px-3 py-1 bg-white rounded-full text-sm font-semibold border-2 border-gray-300">Poule ' + item.poules[j] + '</span>';
            }
            html += '</div>';
          }
          html += '</div></div>';
        }
        
        html += '</div><div class="mt-8 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded">';
        html += '<h3 class="font-bold text-lg mb-2">üìå Rappel important :</h3>';
        html += '<ul class="list-disc list-inside space-y-1 text-gray-700">';
        html += '<li>Chaque poule se rencontre 2 fois (2 rounds par poule)</li>';
        html += '<li><strong>NOUVEAU :</strong> Pr√©cision au tir privil√©gi√©e ! Si pourcentage < ' + this.settings.minPercentage + '% ‚Üí +1 minute de p√©nalit√©</li>';
        html += '<li>Les 2 premiers de chaque poule ‚Üí Tournoi Principal (8 √©quipes)</li>';
        html += '<li>Les 2 derniers de chaque poule ‚Üí Tournoi Consolante (8 √©quipes)</li>';
        html += '<li><strong>FINALE UNIQUE :</strong> Un seul tour pour classer de 1 √† 16</li>';
        html += '</ul></div></div>';
        return html;
      }

      renderPoule(poule) {
        const ranking = this.getRanking(poule);
        const teams = this.poulesData[poule];
        const self = this;
        
        let html = '<div class="space-y-6">';
        html += '<div class="flex justify-between items-center">';
        html += '<h2 class="text-3xl font-bold">Poule ' + poule + '</h2>';
        const totalMembers = teams.reduce((acc, t) => acc + t.members.length, 0);
        html += '<div class="text-sm text-gray-600">' + teams.length + ' √©quipes ‚Ä¢ ' + totalMembers + ' √©l√®ves</div>';
        html += '</div>';

        html += this.renderSettingsBar();

        // Composition
        html += '<div><h3 class="text-xl font-semibold mb-3">üë• Composition des √©quipes</h3>';
        html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
        for (let i = 0; i < teams.length; i++) {
          const team = teams[i];
          html += '<div class="border-2 border-gray-200 rounded-lg p-4 bg-white">';
          html += '<div class="font-bold text-lg mb-2 text-blue-700">' + team.name + '</div><ul class="space-y-1">';
          for (let j = 0; j < team.members.length; j++) {
            html += '<li class="text-gray-700">‚Ä¢ ' + team.members[j] + '</li>';
          }
          html += '</ul></div>';
        }
        html += '</div></div>';

        // R√©sultats
        html += '<div><h3 class="text-xl font-semibold mb-3">üéØ R√©sultats des Rounds</h3>';
        html += '<div class="space-y-4">';
        for (let i = 0; i < teams.length; i++) {
          const team = teams[i];
          const result = self.getTeamResult(poule, team.name);
          html += '<div class="border-2 border-gray-200 rounded-lg p-4 bg-white">';
          html += '<div class="font-bold text-lg mb-3 text-blue-700">' + team.name + '</div>';
          html += '<div class="grid grid-cols-2 gap-4">';
          
          for (let round = 1; round <= 2; round++) {
            const percentage = self.calculateRoundPercentage(result, round);
            const penalty = self.calculateRoundPenalty(result, round);
            const baseTime = self.parseTime(result['round' + round + '_time'] || 0);
            const adjustedTime = baseTime + penalty;
            
            html += '<div class="border rounded p-3 bg-gray-50">';
            html += '<div class="font-semibold mb-2">Round ' + round + '</div>';
            html += '<div class="space-y-2">';
            
            html += '<div><label class="block text-xs text-gray-600 mb-1">Nombre de tirs (20 ou 25)</label>';
            html += '<input type="number" min="20" max="25" step="5" value="' + (result['round' + round + '_maxtirs'] || '20') + '" ';
            html += 'onchange="app.updateResult(\'' + poule + '\', \'' + team.name + '\', ' + round + ', \'maxtirs\', this.value)" ';
            html += 'class="w-full px-2 py-1 border rounded text-sm font-semibold" placeholder="20"/></div>';
            
            html += '<div><label class="block text-xs text-gray-600 mb-1">Tirs r√©ussis Blanches</label>';
            html += '<input type="number" min="0" value="' + (result['round' + round + '_blanc'] || '') + '" ';
            html += 'onchange="app.updateResult(\'' + poule + '\', \'' + team.name + '\', ' + round + ', \'blanc\', this.value)" ';
            html += 'class="w-full px-2 py-1 border rounded text-sm" placeholder="0"/></div>';
            
            html += '<div><label class="block text-xs text-gray-600 mb-1">Tirs r√©ussis Jaunes</label>';
            html += '<input type="number" min="0" value="' + (result['round' + round + '_jaune'] || '') + '" ';
            html += 'onchange="app.updateResult(\'' + poule + '\', \'' + team.name + '\', ' + round + ', \'jaune\', this.value)" ';
            html += 'class="w-full px-2 py-1 border rounded text-sm" placeholder="0"/></div>';
            
            if (percentage > 0) {
              html += '<div class="text-xs font-semibold ' + (penalty > 0 ? 'text-red-600' : 'text-green-600') + '">';
              html += 'üéØ ' + percentage.toFixed(1) + '% au tir';
              html += '</div>';
            }
            
            html += '<div><label class="block text-xs text-gray-600 mb-1">Temps brut (MM:SS)</label>';
            html += '<input type="text" value="' + (result['round' + round + '_time'] || '') + '" ';
            html += 'onchange="app.updateResult(\'' + poule + '\', \'' + team.name + '\', ' + round + ', \'time\', this.value)" ';
            html += 'class="w-full px-2 py-1 border rounded text-sm font-semibold" placeholder="4:05.50"/></div>';
            
            if (baseTime > 0) {
              html += '<div class="text-xs">';
              html += '<div>Temps brut: ' + self.formatTime(baseTime) + '</div>';
              if (penalty > 0) {
                html += '<div class="text-red-600 font-bold">+ P√©nalit√©: ' + self.formatPenalty(penalty) + '</div>';
              }
              html += '<div class="font-bold text-blue-600">= Total: ' + self.formatTime(adjustedTime) + '</div>';
              html += '</div>';
            }
            
            html += '</div></div>';
          }
          html += '</div></div>';
        }
        html += '</div></div>';

        // Classement
        html += '<div><h3 class="text-xl font-semibold mb-3">üèÜ Classement de la Poule ' + poule + '</h3>';
        html += '<div class="border-2 border-gray-300 rounded-lg overflow-hidden"><table class="w-full">';
        html += '<thead class="bg-gray-800 text-white"><tr>';
        html += '<th class="p-3 text-left">Position</th>';
        html += '<th class="p-3 text-left">√âquipe</th>';
        html += '<th class="p-3 text-center">% Tir Moyen</th>';
        html += '<th class="p-3 text-center">R1 Temps</th>';
        html += '<th class="p-3 text-center">R2 Temps</th>';
        html += '<th class="p-3 text-center font-bold">TOTAL</th>';
        html += '<th class="p-3 text-center">Qualification</th>';
        html += '</tr></thead><tbody>';
        
        for (let idx = 0; idx < ranking.length; idx++) {
          const team = ranking[idx];
          const result = team.result;
          
          const r1Time = self.calculateAdjustedRoundTime(result, 1);
          const r2Time = self.calculateAdjustedRoundTime(result, 2);
          const r1 = r1Time > 0 ? self.formatTime(r1Time) : '-';
          const r2 = r2Time > 0 ? self.formatTime(r2Time) : '-';
          const total = team.totalTime > 0 ? self.formatTime(team.totalTime) : '-';
          const avgPercentage = team.avgPercentage > 0 ? team.avgPercentage.toFixed(1) + '%' : '-';
          
          let qualif = '';
          let qualifClass = '';
          if (team.totalTime > 0) {
            if (idx === 0 || idx === 1) {
              qualif = 'üèÜ Tournoi Principal';
              qualifClass = 'bg-green-100 text-green-800 font-semibold';
            } else {
              qualif = 'üéØ Tournoi Consolante';
              qualifClass = 'bg-orange-100 text-orange-800';
            }
          }
          
          const rowClass = idx % 2 === 0 ? 'bg-white' : 'bg-gray-50';
          html += '<tr class="' + rowClass + '">';
          html += '<td class="p-3 font-bold text-lg">' + (team.totalTime > 0 ? (idx + 1) + (idx === 0 ? 'er' : '√®me') : '-') + '</td>';
          html += '<td class="p-3 font-semibold">' + team.name + '</td>';
          html += '<td class="p-3 text-center font-semibold">' + avgPercentage + '</td>';
          html += '<td class="p-3 text-center">' + r1 + '</td>';
          html += '<td class="p-3 text-center">' + r2 + '</td>';
          html += '<td class="p-3 text-center font-bold text-lg">' + total + '</td>';
          html += '<td class="p-3 text-center text-sm ' + qualifClass + '">' + qualif + '</td>';
          html += '</tr>';
        }
        
        html += '</tbody></table></div></div></div>';
        return html;
      }

      renderFinales() {
        const allRankings = {
          A: this.getRanking('A'),
          B: this.getRanking('B'),
          C: this.getRanking('C'),
          D: this.getRanking('D')
        };

        const principal = [];
        const consolante = [];

        const poules = Object.keys(allRankings);
        for (let i = 0; i < poules.length; i++) {
          const poule = poules[i];
          const teams = allRankings[poule];
          for (let j = 0; j < teams.length; j++) {
            const team = teams[j];
            const idx = j;
            if (team.totalTime > 0) {
              if (idx === 0 || idx === 1) {
                principal.push({
                  name: team.name, 
                  poule: poule, 
                  position: idx + 1, 
                  totalTime: team.totalTime,
                  avgPercentage: team.avgPercentage
                });
              } else if (idx === 2 || idx === 3) {
                consolante.push({
                  name: team.name, 
                  poule: poule, 
                  position: idx + 1, 
                  totalTime: team.totalTime,
                  avgPercentage: team.avgPercentage
                });
              }
            }
          }
        }

        const self = this;
        let html = '<div class="space-y-6">';
        html += '<h2 class="text-3xl font-bold">üèÜ Phases Finales - R√©capitulatif</h2>';
        html += '<div class="p-4 bg-blue-50 border-l-4 border-blue-500 rounded">';
        html += '<p class="font-semibold">‚è∞ Horaire : 10h45 - 11h15</p>';
        html += '<p class="text-sm text-gray-700 mt-1"><strong>FINALE UNIQUE :</strong> Les 16 √©quipes font un run final pour le classement de 1 √† 16</p>';
        html += '<p class="text-sm text-red-600 font-bold mt-2">‚ö†Ô∏è P√©nalit√© de +1 min si % tir < ' + this.settings.minPercentage + '%</p>';
        html += '</div>';

        // Tableau Principal
        html += '<div><h3 class="text-2xl font-bold mb-4 text-green-700">üèÜ Tournoi Principal</h3>';
        html += '<div class="border-2 border-green-500 rounded-lg overflow-hidden"><table class="w-full">';
        html += '<thead class="bg-green-700 text-white"><tr>';
        html += '<th class="p-3 text-left">Poule</th>';
        html += '<th class="p-3 text-left">Position</th>';
        html += '<th class="p-3 text-left">√âquipe</th>';
        html += '<th class="p-3 text-center">% Tir Qualifs</th>';
        html += '<th class="p-3 text-center">Temps Total Qualifs</th>';
        html += '</tr></thead><tbody>';
        
        if (principal.length > 0) {
          for (let idx = 0; idx < principal.length; idx++) {
            const team = principal[idx];
            const rowClass = idx % 2 === 0 ? 'bg-white' : 'bg-green-50';
            html += '<tr class="' + rowClass + '">';
            html += '<td class="p-3 font-bold">Poule ' + team.poule + '</td>';
            html += '<td class="p-3">' + (team.position === 1 ? '1er' : '2√®me') + '</td>';
            html += '<td class="p-3 font-semibold">' + team.name + '</td>';
            html += '<td class="p-3 text-center font-semibold">' + team.avgPercentage.toFixed(1) + '%</td>';
            html += '<td class="p-3 text-center">' + self.formatTime(team.totalTime) + '</td>';
            html += '</tr>';
          }
        } else {
          html += '<tr><td colspan="5" class="p-6 text-center text-gray-500">En attente des r√©sultats des qualifications...</td></tr>';
        }
        html += '</tbody></table></div></div>';

        // Tableau Consolante
        html += '<div><h3 class="text-2xl font-bold mb-4 text-orange-700">üéØ Tournoi Consolante</h3>';
        html += '<div class="border-2 border-orange-500 rounded-lg overflow-hidden"><table class="w-full">';
        html += '<thead class="bg-orange-600 text-white"><tr>';
        html += '<th class="p-3 text-left">Poule</th>';
        html += '<th class="p-3 text-left">Position</th>';
        html += '<th class="p-3 text-left">√âquipe</th>';
        html += '<th class="p-3 text-center">% Tir Qualifs</th>';
        html += '<th class="p-3 text-center">Temps Total Qualifs</th>';
        html += '</tr></thead><tbody>';
        
        if (consolante.length > 0) {
          for (let idx = 0; idx < consolante.length; idx++) {
            const team = consolante[idx];
            const rowClass = idx % 2 === 0 ? 'bg-white' : 'bg-orange-50';
            html += '<tr class="' + rowClass + '">';
            html += '<td class="p-3 font-bold">Poule ' + team.poule + '</td>';
            html += '<td class="p-3">' + (team.position === 3 ? '3√®me' : '4√®me') + '</td>';
            html += '<td class="p-3 font-semibold">' + team.name + '</td>';
            html += '<td class="p-3 text-center font-semibold">' + team.avgPercentage.toFixed(1) + '%</td>';
            html += '<td class="p-3 text-center">' + self.formatTime(team.totalTime) + '</td>';
            html += '</tr>';
          }
        } else {
          html += '<tr><td colspan="5" class="p-6 text-center text-gray-500">En attente des r√©sultats des qualifications...</td></tr>';
        }
        html += '</tbody></table></div></div>';

        html += '</div>';
        return html;
      }

      renderTournament(type) {
        const teams = this.getQualifiedTeams(type);
        const title = type === 'principal' ? 'üèÜ Tournoi Principal' : 'üéØ Tournoi Consolante';
        const colorClass = type === 'principal' ? 'green' : 'orange';
        const self = this;

        if (teams.length < 8) {
          let html = '<div class="space-y-6">';
          html += '<h2 class="text-3xl font-bold">' + title + '</h2>';
          html += '<div class="p-8 bg-gray-50 border-2 border-gray-200 rounded-lg text-center">';
          html += '<p class="text-xl text-gray-600">‚è≥ En attente de la fin des qualifications...</p>';
          html += '<p class="text-sm text-gray-500 mt-2">Il faut que les 4 poules aient termin√© leurs 2 rounds pour afficher le tournoi.</p>';
          html += '</div></div>';
          return html;
        }

        let html = '<div class="space-y-6">';
        html += '<h2 class="text-3xl font-bold">' + title + '</h2>';
        
        html += this.renderSettingsBar();

        html += '<div class="p-4 bg-' + colorClass + '-50 border-l-4 border-' + colorClass + '-500 rounded">';
        html += '<p class="font-semibold">8 √©quipes qualifi√©es - FINALE UNIQUE</p>';
        html += '<p class="text-sm text-gray-700 mt-1">Saisissez le nombre de tirs, tirs r√©ussis et temps pour chaque √©quipe</p>';
        html += '<p class="text-sm text-gray-700">Ce tour d√©termine le classement final ' + (type === 'principal' ? 'de 1 √† 8' : 'de 9 √† 16') + '</p>';
        html += '</div>';

        // Finale Unique
        html += '<div class="border-2 border-' + colorClass + '-300 rounded-lg p-6 bg-white">';
        html += '<h3 class="text-2xl font-bold mb-4 text-' + colorClass + '-700">üèÅ FINALE - Les 8 √©quipes</h3>';
        
        html += '<div class="space-y-3">';
        for (let i = 0; i < teams.length; i++) {
          const team = teams[i];
          const tirs = self.getFinaleResult(type, team.name, 'tirs');
          const maxTirs = self.getFinaleResult(type, team.name, 'maxtirs') || '20';
          const time = self.getFinaleResult(type, team.name, 'time');
          const percentage = self.calculateFinalePercentage(type, team.name);
          const penalty = self.calculateFinalePenalty(type, team.name);
          const baseTime = self.parseTime(time);
          const adjustedTime = baseTime + penalty;
          
          html += '<div class="p-3 bg-gray-50 rounded-lg border-2 border-gray-200">';
          html += '<div class="flex items-center gap-4 mb-2">';
          html += '<div class="flex-1 font-semibold text-lg">' + team.name + '</div>';
          html += '<div class="text-xs text-gray-500">(Poule ' + team.poule + ' - ' + (team.position === 1 ? '1er' : team.position === 2 ? '2√®me' : team.position === 3 ? '3√®me' : '4√®me') + ')</div>';
          html += '</div>';
          
          html += '<div class="grid grid-cols-4 gap-2">';
          html += '<div>';
          html += '<label class="text-xs text-gray-600">Nb tirs (20/25)</label>';
          html += '<input type="number" min="20" max="25" step="5" value="' + maxTirs + '" ';
          html += 'onchange="app.updateFinaleResult(\'' + type + '\', \'' + team.name + '\', \'maxtirs\', this.value)" ';
          html += 'class="w-full px-2 py-1 border-2 border-gray-300 rounded text-sm font-semibold"/>';
          html += '</div>';
          
          html += '<div>';
          html += '<label class="text-xs text-gray-600">Tirs r√©ussis</label>';
          html += '<input type="number" min="0" value="' + tirs + '" ';
          html += 'onchange="app.updateFinaleResult(\'' + type + '\', \'' + team.name + '\', \'tirs\', this.value)" ';
          html += 'class="w-full px-2 py-1 border-2 border-gray-300 rounded text-sm font-semibold"/>';
          html += '</div>';
          
          html += '<div>';
          html += '<label class="text-xs text-gray-600">Temps brut</label>';
          html += '<input type="text" value="' + time + '" ';
          html += 'onchange="app.updateFinaleResult(\'' + type + '\', \'' + team.name + '\', \'time\', this.value)" ';
          html += 'class="w-full px-2 py-1 border-2 border-gray-300 rounded text-sm font-semibold" placeholder="MM:SS"/>';
          html += '</div>';
          
          html += '<div class="text-xs">';
          if (percentage > 0) {
            html += '<div class="font-semibold ' + (penalty > 0 ? 'text-red-600' : 'text-green-600') + '">üéØ ' + percentage.toFixed(1) + '%</div>';
          }
          if (baseTime > 0) {
            html += '<div>Brut: ' + self.formatTime(baseTime) + '</div>';
            if (penalty > 0) {
              html += '<div class="text-red-600 font-bold">' + self.formatPenalty(penalty) + '</div>';
            }
            html += '<div class="font-bold text-blue-600">' + self.formatTime(adjustedTime) + '</div>';
          }
          html += '</div>';
          
          html += '</div></div>';
        }
        html += '</div>';

        // Classement Final
        const finaleRanking = self.getFinaleRanking(type, teams);
        const finalists = finaleRanking.filter(t => t.adjustedTime > 0);
        
        if (finalists.length > 0) {
          html += '<div class="mt-4 p-4 bg-' + colorClass + '-50 rounded-lg border-2 border-' + colorClass + '-400">';
          html += '<h4 class="font-bold text-' + colorClass + '-900 mb-3 text-lg">üèÖ CLASSEMENT FINAL:</h4>';
          html += '<div class="space-y-2">';
          const startPlace = type === 'principal' ? 1 : 9;
          for (let i = 0; i < finalists.length; i++) {
            const place = startPlace + i;
            const medal = type === 'principal' ? (i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : 'üèÖ') : 'üèÖ';
            html += '<div class="flex justify-between items-center p-2 bg-white rounded">';
            html += '<span class="font-bold text-xl">' + medal + ' ' + place + (place === 1 ? 'er' : '√®me') + '. ' + finalists[i].name + '</span>';
            html += '<div class="text-right">';
            html += '<span class="text-xs text-gray-600 mr-2">üéØ ' + finalists[i].percentage.toFixed(1) + '%</span>';
            html += '<span class="text-lg font-bold text-' + colorClass + '-700">' + self.formatTime(finalists[i].adjustedTime) + '</span>';
            html += '</div></div>';
          }
          html += '</div></div>';
        }

        html += '</div>';
        html += '</div>';
        return html;
      }

      renderClassementGeneral() {
        const self = this;
        
        // R√©cup√©rer toutes les √©quipes avec leurs r√©sultats complets
        const allTeams = [];
        const poules = ['A', 'B', 'C', 'D'];
        
        for (let p = 0; p < poules.length; p++) {
          const poule = poules[p];
          const teams = this.poulesData[poule];
          
          for (let t = 0; t < teams.length; t++) {
            const team = teams[t];
            const qualifResult = this.getTeamResult(poule, team.name);
            
            // D√©terminer le type de tournoi bas√© sur la position R√âELLE dans le classement
            const ranking = this.getRanking(poule);
            const teamRanking = ranking.find(r => r.name === team.name);
            let position = -1;
            
            // Trouver la position r√©elle en comptant uniquement les √©quipes avec un temps
            let currentPos = 0;
            for (let r = 0; r < ranking.length; r++) {
              if (ranking[r].totalTime > 0) {
                if (ranking[r].name === team.name) {
                  position = currentPos;
                  break;
                }
                currentPos++;
              }
            }
            
            let tournamentType = '';
            if (position === 0 || position === 1) {
              tournamentType = 'principal';
            } else if (position === 2 || position === 3) {
              tournamentType = 'consolante';
            }
            
            // R√©cup√©rer les r√©sultats de finale si disponibles
            let finaleTime = 0;
            let finalePct = 0;
            if (tournamentType) {
              finaleTime = this.calculateAdjustedFinaleTime(tournamentType, team.name);
              finalePct = this.calculateFinalePercentage(tournamentType, team.name);
            }
            
            allTeams.push({
              name: team.name,
              members: team.members,
              poule: poule,
              position: position + 1,
              tournamentType: tournamentType,
              // R√©sultats qualifs
              r1Blanc: parseInt(qualifResult['round1_blanc'] || 0),
              r1Jaune: parseInt(qualifResult['round1_jaune'] || 0),
              r1MaxTirs: parseInt(qualifResult['round1_maxtirs'] || 20),
              r1Time: this.parseTime(qualifResult['round1_time'] || 0),
              r1Pct: this.calculateRoundPercentage(qualifResult, 1),
              r1Penalty: this.calculateRoundPenalty(qualifResult, 1),
              r2Blanc: parseInt(qualifResult['round2_blanc'] || 0),
              r2Jaune: parseInt(qualifResult['round2_jaune'] || 0),
              r2MaxTirs: parseInt(qualifResult['round2_maxtirs'] || 20),
              r2Time: this.parseTime(qualifResult['round2_time'] || 0),
              r2Pct: this.calculateRoundPercentage(qualifResult, 2),
              r2Penalty: this.calculateRoundPenalty(qualifResult, 2),
              qualifTotal: this.calculateTotalTime(poule, team.name),
              // R√©sultats finale
              finaleTime: finaleTime,
              finalePct: finalePct
            });
          }
        }
        
        // NOUVEAU TRI : Respecter la hi√©rarchie Principal (1-8) puis Consolante (9-16)
        // S√©parer les √©quipes par tournoi
        const principalTeams = allTeams.filter(t => t.tournamentType === 'principal');
        const consolanteTeams = allTeams.filter(t => t.tournamentType === 'consolante');
        
        // Trier chaque groupe par temps de finale
        principalTeams.sort((a, b) => {
          if (a.finaleTime === 0 && b.finaleTime === 0) return 0;
          if (a.finaleTime === 0) return 1;
          if (b.finaleTime === 0) return -1;
          return a.finaleTime - b.finaleTime;
        });
        
        consolanteTeams.sort((a, b) => {
          if (a.finaleTime === 0 && b.finaleTime === 0) return 0;
          if (a.finaleTime === 0) return 1;
          if (b.finaleTime === 0) return -1;
          return a.finaleTime - b.finaleTime;
        });
        
        // Combiner : Principal d'abord (1-8), puis Consolante (9-16)
        allTeams.length = 0;
        allTeams.push(...principalTeams);
        allTeams.push(...consolanteTeams);
        
        let html = '<div class="space-y-6">';
        html += '<h2 class="text-3xl font-bold">üèÖ Classement G√©n√©ral du Tournoi</h2>';
        
        html += '<div class="p-4 bg-gradient-to-r from-yellow-50 to-orange-50 border-l-4 border-yellow-500 rounded">';
        html += '<p class="font-semibold text-lg">üéØ Classement final de 1 √† 16</p>';
        html += '<p class="text-sm text-gray-700 mt-1">Bas√© sur les temps de la finale unique (avec p√©nalit√©s si % < ' + this.settings.minPercentage + '%)</p>';
        html += '<p class="text-sm text-gray-700">D√©tails complets : Qualifications (R1 + R2) + Finale</p>';
        html += '<p class="text-sm font-semibold text-orange-700 mt-2">‚ö†Ô∏è Hi√©rarchie : Tournoi Principal = places 1 √† 8 | Tournoi Consolante = places 9 √† 16</p>';
        html += '</div>';

        // S√©paration visuelle : TOURNOI PRINCIPAL (1-8)
        html += '<div class="mt-6 border-4 border-green-600 rounded-xl overflow-hidden shadow-lg">';
        html += '<div class="bg-gradient-to-r from-green-700 to-green-900 text-white p-4">';
        html += '<h3 class="text-2xl font-bold">üèÜ TOURNOI PRINCIPAL - Places 1 √† 8</h3>';
        html += '<p class="text-sm mt-1">Les 2 premiers de chaque poule</p>';
        html += '</div>';
        
        html += '<div class="overflow-x-auto">';
        html += '<table class="w-full text-sm">';
        html += '<thead class="bg-gradient-to-r from-slate-700 to-slate-900 text-white">';
        html += '<tr>';
        html += '<th class="p-2 text-left" rowspan="2">Place</th>';
        html += '<th class="p-2 text-left" rowspan="2">√âquipe et √âl√®ves</th>';
        html += '<th class="p-2 text-center border-l border-slate-600" colspan="4">Round 1 (Qualifs)</th>';
        html += '<th class="p-2 text-center border-l border-slate-600" colspan="4">Round 2 (Qualifs)</th>';
        html += '<th class="p-2 text-center border-l border-slate-600" rowspan="2">Total<br/>Qualifs</th>';
        html += '<th class="p-2 text-center border-l border-yellow-400 bg-yellow-600" colspan="2">FINALE</th>';
        html += '</tr>';
        html += '<tr class="border-t border-slate-600">';
        html += '<th class="p-2 text-center border-l border-slate-600">Tirs</th>';
        html += '<th class="p-2 text-center">%</th>';
        html += '<th class="p-2 text-center">Temps</th>';
        html += '<th class="p-2 text-center">Total</th>';
        html += '<th class="p-2 text-center border-l border-slate-600">Tirs</th>';
        html += '<th class="p-2 text-center">%</th>';
        html += '<th class="p-2 text-center">Temps</th>';
        html += '<th class="p-2 text-center">Total</th>';
        html += '<th class="p-2 text-center border-l border-yellow-400 bg-yellow-600">%</th>';
        html += '<th class="p-2 text-center bg-yellow-600">Temps</th>';
        html += '</tr>';
        html += '</thead>';
        html += '<tbody>';
        
        // Afficher les √©quipes du PRINCIPAL (0-7)
        for (let i = 0; i < Math.min(8, allTeams.length); i++) {
          const team = allTeams[i];
          if (team.tournamentType !== 'principal') continue;
          
          const hasFinale = team.finaleTime > 0;
          
          let rowColor = '';
          if (i === 0) rowColor = 'bg-yellow-100 border-l-4 border-yellow-500';
          else if (i === 1) rowColor = 'bg-gray-100 border-l-4 border-gray-400';
          else if (i === 2) rowColor = 'bg-orange-100 border-l-4 border-orange-400';
          else rowColor = 'bg-green-50';
          
          const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '';
          
          html += '<tr class="border-b ' + rowColor + '">';
          html += '<td class="p-2 font-bold text-lg align-top">' + medal + ' ' + (hasFinale ? (i + 1) + (i === 0 ? 'er' : '√®me') : '-') + '</td>';
          html += '<td class="p-2 align-top">';
          html += '<div class="font-bold text-base mb-1">' + team.name + '</div>';
          html += '<div class="text-xs text-gray-600">Poule ' + team.poule + ' - ' + (team.position === 1 ? '1er' : team.position + '√®me') + '</div>';
          if (team.members && team.members.length > 0) {
            html += '<div class="text-xs text-gray-500 mt-1">';
            for (let m = 0; m < team.members.length; m++) {
              html += '<div>‚Ä¢ ' + team.members[m] + '</div>';
            }
            html += '</div>';
          }
          html += '</td>';
          
          // Round 1
          html += '<td class="p-2 text-center border-l border-gray-300">';
          html += team.r1Blanc + team.r1Jaune > 0 ? (team.r1Blanc + team.r1Jaune) + '/' + (team.r1MaxTirs * 2) : '-';
          html += '</td>';
          html += '<td class="p-2 text-center ' + (team.r1Penalty > 0 ? 'text-red-600 font-bold' : 'text-green-600') + '">';
          html += team.r1Pct > 0 ? team.r1Pct.toFixed(1) + '%' : '-';
          html += '</td>';
          html += '<td class="p-2 text-center">';
          html += team.r1Time > 0 ? self.formatTime(team.r1Time) : '-';
          if (team.r1Penalty > 0) html += '<div class="text-xs text-red-600">' + self.formatPenalty(team.r1Penalty) + '</div>';
          html += '</td>';
          html += '<td class="p-2 text-center font-semibold">';
          html += team.r1Time > 0 ? self.formatTime(team.r1Time + team.r1Penalty) : '-';
          html += '</td>';
          
          // Round 2
          html += '<td class="p-2 text-center border-l border-gray-300">';
          html += team.r2Blanc + team.r2Jaune > 0 ? (team.r2Blanc + team.r2Jaune) + '/' + (team.r2MaxTirs * 2) : '-';
          html += '</td>';
          html += '<td class="p-2 text-center ' + (team.r2Penalty > 0 ? 'text-red-600 font-bold' : 'text-green-600') + '">';
          html += team.r2Pct > 0 ? team.r2Pct.toFixed(1) + '%' : '-';
          html += '</td>';
          html += '<td class="p-2 text-center">';
          html += team.r2Time > 0 ? self.formatTime(team.r2Time) : '-';
          if (team.r2Penalty > 0) html += '<div class="text-xs text-red-600">' + self.formatPenalty(team.r2Penalty) + '</div>';
          html += '</td>';
          html += '<td class="p-2 text-center font-semibold">';
          html += team.r2Time > 0 ? self.formatTime(team.r2Time + team.r2Penalty) : '-';
          html += '</td>';
          
          // Total Qualifs
          html += '<td class="p-2 text-center font-bold border-l border-gray-300">';
          html += team.qualifTotal > 0 ? self.formatTime(team.qualifTotal) : '-';
          html += '</td>';
          
          // Finale
          html += '<td class="p-2 text-center border-l border-yellow-400 bg-yellow-50 ' + (team.finalePct < self.settings.minPercentage && team.finalePct > 0 ? 'text-red-600 font-bold' : 'text-green-600') + '">';
          html += team.finalePct > 0 ? team.finalePct.toFixed(1) + '%' : '-';
          html += '</td>';
          html += '<td class="p-2 text-center bg-yellow-50 font-bold text-base">';
          html += team.finaleTime > 0 ? self.formatTime(team.finaleTime) : '-';
          html += '</td>';
          
          html += '</tr>';
        }
        
        html += '</tbody>';
        html += '</table>';
        html += '</div>';
        html += '</div>';
        
        // S√©paration visuelle : TOURNOI CONSOLANTE (9-16)
        html += '<div class="mt-8 border-4 border-orange-600 rounded-xl overflow-hidden shadow-lg">';
        html += '<div class="bg-gradient-to-r from-orange-600 to-orange-800 text-white p-4">';
        html += '<h3 class="text-2xl font-bold">üéØ TOURNOI CONSOLANTE - Places 9 √† 16</h3>';
        html += '<p class="text-sm mt-1">Les 3√®me et 4√®me de chaque poule</p>';
        html += '</div>';
        
        html += '<div class="overflow-x-auto">';
        html += '<table class="w-full text-sm">';
        html += '<thead class="bg-gradient-to-r from-slate-700 to-slate-900 text-white">';
        html += '<tr>';
        html += '<th class="p-2 text-left" rowspan="2">Place</th>';
        html += '<th class="p-2 text-left" rowspan="2">√âquipe et √âl√®ves</th>';
        html += '<th class="p-2 text-center border-l border-slate-600" colspan="4">Round 1 (Qualifs)</th>';
        html += '<th class="p-2 text-center border-l border-slate-600" colspan="4">Round 2 (Qualifs)</th>';
        html += '<th class="p-2 text-center border-l border-slate-600" rowspan="2">Total<br/>Qualifs</th>';
        html += '<th class="p-2 text-center border-l border-yellow-400 bg-yellow-600" colspan="2">FINALE</th>';
        html += '</tr>';
        html += '<tr class="border-t border-slate-600">';
        html += '<th class="p-2 text-center border-l border-slate-600">Tirs</th>';
        html += '<th class="p-2 text-center">%</th>';
        html += '<th class="p-2 text-center">Temps</th>';
        html += '<th class="p-2 text-center">Total</th>';
        html += '<th class="p-2 text-center border-l border-slate-600">Tirs</th>';
        html += '<th class="p-2 text-center">%</th>';
        html += '<th class="p-2 text-center">Temps</th>';
        html += '<th class="p-2 text-center">Total</th>';
        html += '<th class="p-2 text-center border-l border-yellow-400 bg-yellow-600">%</th>';
        html += '<th class="p-2 text-center bg-yellow-600">Temps</th>';
        html += '</tr>';
        html += '</thead>';
        html += '<tbody>';
        
        // Afficher les √©quipes de CONSOLANTE (8-15)
        for (let i = 0; i < allTeams.length; i++) {
          const team = allTeams[i];
          if (team.tournamentType !== 'consolante') continue;
          
          const hasFinale = team.finaleTime > 0;
          const place = 9 + consolanteTeams.indexOf(team);
          
          let rowColor = 'bg-orange-50';
          
          html += '<tr class="border-b ' + rowColor + '">';
          html += '<td class="p-2 font-bold text-lg align-top">' + (hasFinale ? place + '√®me' : '-') + '</td>';
          html += '<td class="p-2 align-top">';
          html += '<div class="font-bold text-base mb-1">' + team.name + '</div>';
          html += '<div class="text-xs text-gray-600">Poule ' + team.poule + ' - ' + (team.position === 3 ? '3√®me' : '4√®me') + '</div>';
          if (team.members && team.members.length > 0) {
            html += '<div class="text-xs text-gray-500 mt-1">';
            for (let m = 0; m < team.members.length; m++) {
              html += '<div>‚Ä¢ ' + team.members[m] + '</div>';
            }
            html += '</div>';
          }
          html += '</td>';
          
          // Round 1
          html += '<td class="p-2 text-center border-l border-gray-300">';
          html += team.r1Blanc + team.r1Jaune > 0 ? (team.r1Blanc + team.r1Jaune) + '/' + (team.r1MaxTirs * 2) : '-';
          html += '</td>';
          html += '<td class="p-2 text-center ' + (team.r1Penalty > 0 ? 'text-red-600 font-bold' : 'text-green-600') + '">';
          html += team.r1Pct > 0 ? team.r1Pct.toFixed(1) + '%' : '-';
          html += '</td>';
          html += '<td class="p-2 text-center">';
          html += team.r1Time > 0 ? self.formatTime(team.r1Time) : '-';
          if (team.r1Penalty > 0) html += '<div class="text-xs text-red-600">' + self.formatPenalty(team.r1Penalty) + '</div>';
          html += '</td>';
          html += '<td class="p-2 text-center font-semibold">';
          html += team.r1Time > 0 ? self.formatTime(team.r1Time + team.r1Penalty) : '-';
          html += '</td>';
          
          // Round 2
          html += '<td class="p-2 text-center border-l border-gray-300">';
          html += team.r2Blanc + team.r2Jaune > 0 ? (team.r2Blanc + team.r2Jaune) + '/' + (team.r2MaxTirs * 2) : '-';
          html += '</td>';
          html += '<td class="p-2 text-center ' + (team.r2Penalty > 0 ? 'text-red-600 font-bold' : 'text-green-600') + '">';
          html += team.r2Pct > 0 ? team.r2Pct.toFixed(1) + '%' : '-';
          html += '</td>';
          html += '<td class="p-2 text-center">';
          html += team.r2Time > 0 ? self.formatTime(team.r2Time) : '-';
          if (team.r2Penalty > 0) html += '<div class="text-xs text-red-600">' + self.formatPenalty(team.r2Penalty) + '</div>';
          html += '</td>';
          html += '<td class="p-2 text-center font-semibold">';
          html += team.r2Time > 0 ? self.formatTime(team.r2Time + team.r2Penalty) : '-';
          html += '</td>';
          
          // Total Qualifs
          html += '<td class="p-2 text-center font-bold border-l border-gray-300">';
          html += team.qualifTotal > 0 ? self.formatTime(team.qualifTotal) : '-';
          html += '</td>';
          
          // Finale
          html += '<td class="p-2 text-center border-l border-yellow-400 bg-yellow-50 ' + (team.finalePct < self.settings.minPercentage && team.finalePct > 0 ? 'text-red-600 font-bold' : 'text-green-600') + '">';
          html += team.finalePct > 0 ? team.finalePct.toFixed(1) + '%' : '-';
          html += '</td>';
          html += '<td class="p-2 text-center bg-yellow-50 font-bold text-base">';
          html += team.finaleTime > 0 ? self.formatTime(team.finaleTime) : '-';
          html += '</td>';
          
          html += '</tr>';
        }
        
        html += '</tbody>';
        html += '</table>';
        html += '</div>';
        html += '</div>';
        
        html += '<div class="p-4 bg-blue-50 border-l-4 border-blue-500 rounded">';
        html += '<p class="font-semibold mb-2">üìä L√©gende :</p>';
        html += '<ul class="list-disc list-inside text-sm text-gray-700 space-y-1">';
        html += '<li><strong>Tirs :</strong> Nombre de tirs r√©ussis / Nombre de tirs maximum √ó 2</li>';
        html += '<li><strong>% :</strong> Pourcentage de pr√©cision au tir (vert = OK, rouge = p√©nalit√©)</li>';
        html += '<li><strong>Total :</strong> Temps brut + p√©nalit√© √©ventuelle</li>';
        html += '<li><strong>Finale :</strong> Temps d√©finitif pour le classement g√©n√©ral</li>';
        html += '</ul>';
        html += '</div>';
        
        html += '</div>';
        return html;
      }

      renderConfiguration() {
        const self = this;
        let html = '<div class="space-y-6">';
        html += '<h2 class="text-3xl font-bold">‚öôÔ∏è Configuration des √âquipes</h2>';
        
        html += '<div class="p-4 bg-blue-50 border-l-4 border-blue-500 rounded">';
        html += '<p class="font-semibold text-lg">‚úèÔ∏è G√©rer les √©quipes et les √©l√®ves</p>';
        html += '<p class="text-sm text-gray-700 mt-1">Ajoutez, retirez, renommez ou d√©placez des √©quipes et des √©l√®ves</p>';
        html += '</div>';

        html += '<div class="flex justify-end">';
        html += '<button onclick="app.resetPoulesData()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-colors">';
        html += 'üîÑ R√©initialiser aux donn√©es par d√©faut';
        html += '</button>';
        html += '</div>';

        const poules = ['A', 'B', 'C', 'D'];
        for (let p = 0; p < poules.length; p++) {
          const poule = poules[p];
          const teams = this.poulesData[poule];
          
          html += '<div class="border-2 border-gray-300 rounded-lg p-6 bg-white">';
          html += '<div class="flex justify-between items-center mb-4">';
          html += '<h3 class="text-2xl font-bold text-blue-700">Poule ' + poule + '</h3>';
          html += '<button onclick="app.addTeam(\'' + poule + '\')" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded font-semibold text-sm">';
          html += '+ Ajouter une √©quipe';
          html += '</button>';
          html += '</div>';

          html += '<div class="space-y-4">';
          for (let t = 0; t < teams.length; t++) {
            const team = teams[t];
            html += '<div class="border border-gray-300 rounded-lg p-4 bg-gray-50">';
            
            html += '<div class="flex justify-between items-center mb-3">';
            html += '<div class="flex items-center gap-3">';
            html += '<input type="text" value="' + team.name + '" ';
            html += 'onchange="app.renameTeam(\'' + poule + '\', ' + t + ', this.value)" ';
            html += 'class="px-3 py-1 border-2 border-blue-300 rounded font-bold text-lg focus:outline-none focus:border-blue-500"/>';
            html += '<span class="text-sm text-gray-600">(' + team.members.length + ' √©l√®ves)</span>';
            html += '</div>';
            
            html += '<div class="flex gap-2">';
            html += '<select onchange="if(this.value) app.moveTeam(\'' + poule + '\', ' + t + ', this.value); this.value=\'\'" ';
            html += 'class="px-2 py-1 border rounded text-sm">';
            html += '<option value="">D√©placer vers...</option>';
            for (let i = 0; i < poules.length; i++) {
              if (poules[i] !== poule) {
                html += '<option value="' + poules[i] + '">Poule ' + poules[i] + '</option>';
              }
            }
            html += '</select>';
            
            html += '<button onclick="app.removeTeam(\'' + poule + '\', ' + t + ')" ';
            html += 'class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-sm font-semibold">Supprimer</button>';
            html += '</div>';
            html += '</div>';

            html += '<div class="space-y-2">';
            html += '<div class="font-semibold text-sm text-gray-700 mb-2">√âl√®ves :</div>';
            for (let m = 0; m < team.members.length; m++) {
              html += '<div class="flex justify-between items-center bg-white p-2 rounded">';
              html += '<span class="text-gray-800">' + team.members[m] + '</span>';
              html += '<button onclick="app.removeMemberFromTeam(\'' + poule + '\', ' + t + ', ' + m + ')" ';
              html += 'class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-xs">Retirer</button>';
              html += '</div>';
            }
            
            html += '<div class="flex gap-2 mt-3">';
            html += '<input type="text" id="newMember_' + poule + '_' + t + '" placeholder="Nom du nouvel √©l√®ve" ';
            html += 'class="flex-1 px-3 py-2 border rounded focus:outline-none focus:border-blue-500"/>';
            html += '<button onclick="const input = document.getElementById(\'newMember_' + poule + '_' + t + '\'); app.addMemberToTeam(\'' + poule + '\', ' + t + ', input.value); input.value=\'\'" ';
            html += 'class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-semibold">+ Ajouter</button>';
            html += '</div>';
            html += '</div>';
            
            html += '</div>';
          }
          html += '</div>';
          html += '</div>';
        }

        html += '<div class="p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded">';
        html += '<p class="font-semibold">üí° Conseils :</p>';
        html += '<ul class="list-disc list-inside text-sm text-gray-700 mt-2 space-y-1">';
        html += '<li>Cliquez sur le nom d\'une √©quipe pour le modifier</li>';
        html += '<li>Utilisez "D√©placer vers..." pour changer une √©quipe de poule</li>';
        html += '<li>Les modifications sont sauvegard√©es automatiquement</li>';
        html += '<li>Utilisez "R√©initialiser" pour revenir aux donn√©es d\'origine</li>';
        html += '</ul>';
        html += '</div>';

        html += '</div>';
        return html;
      }

      render() {
        let content = '';
        if (this.activeTab === 'planning') {
          content = this.renderPlanning();
        } else if (this.activeTab === 'configuration') {
          content = this.renderConfiguration();
        } else if (this.activeTab === 'finales') {
          content = this.renderFinales();
        } else if (this.activeTab === 'tournoi-principal') {
          content = this.renderTournament('principal');
        } else if (this.activeTab === 'tournoi-consolante') {
          content = this.renderTournament('consolante');
        } else if (this.activeTab === 'classement-general') {
          content = this.renderClassementGeneral();
        } else {
          content = this.renderPoule(this.activeTab);
        }

        let html = '<div class="min-h-screen">';
        
        html += '<div class="bg-gradient-to-r from-slate-800 to-slate-900 text-white shadow-lg">';
        html += '<div class="max-w-7xl mx-auto px-6 py-6">';
        html += '<div class="flex items-center justify-between"><div>';
        html += '<h1 class="text-4xl font-bold tracking-tight">Challenge Biathlon 3√®me</h1>';
        html += '<p class="text-slate-300 mt-1">Yves du Manoir ‚Ä¢ 3 F√©vrier 2026 ‚Ä¢ Finale Unique Simplifi√©e</p>';
        html += '</div>';
        html += '<div class="flex items-center gap-3">';
        html += '<div id="firebase-status" class="px-3 py-1 rounded-full text-xs font-semibold">';
        html += '<span id="status-icon">üîÑ</span> <span id="status-text">Connexion...</span>';
        html += '</div>';
        html += '<button onclick="app.clearAllData()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-semibold transition-colors">Effacer toutes les donn√©es</button>';
        html += '</div></div></div></div>';

        html += '<div class="bg-white border-b-2 border-gray-200 shadow-sm sticky top-0 z-10">';
        html += '<div class="max-w-7xl mx-auto px-6"><div class="flex gap-2 overflow-x-auto py-2">';
        
        const tabs = [
          {id: 'planning', label: 'üìÖ Planning'},
          {id: 'configuration', label: '‚öôÔ∏è Configuration'},
          {id: 'A', label: 'Poule A'},
          {id: 'B', label: 'Poule B'},
          {id: 'C', label: 'Poule C'},
          {id: 'D', label: 'Poule D'},
          {id: 'finales', label: 'üìã R√©capitulatif'},
          {id: 'tournoi-principal', label: 'üèÜ Tournoi Principal'},
          {id: 'tournoi-consolante', label: 'üéØ Tournoi Consolante'},
          {id: 'classement-general', label: 'üèÖ Classement G√©n√©ral'}
        ];
        
        for (let i = 0; i < tabs.length; i++) {
          const tab = tabs[i];
          const activeClass = this.activeTab === tab.id ? 'bg-slate-800 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200';
          html += '<button onclick="app.setTab(\'' + tab.id + '\')" class="px-6 py-3 rounded-lg font-semibold whitespace-nowrap transition-all ' + activeClass + '">';
          html += tab.label + '</button>';
        }
        
        html += '</div></div></div>';

        html += '<div class="max-w-7xl mx-auto px-6 py-8">' + content + '</div>';
        html += '</div>';

        document.getElementById('app').innerHTML = html;
      }

      setTab(tab) {
        this.activeTab = tab;
        this.render();
      }

      async initAsync() {
        try {
          this.render();
          await new Promise(resolve => setTimeout(resolve, 100));
          
          updateFirebaseStatus('syncing', 'Chargement...');
          
          this.poulesData = await this.loadPoulesData();
          this.results = await this.loadResults();
          this.settings = await this.loadSettings();
          
          database.ref('biathlon-data').on('value', (snapshot) => {
            if (snapshot.exists()) {
              const data = snapshot.val();
              this.poulesData = data.poules || POULES_DATA;
              this.results = data.results || {};
              this.settings = data.settings || { minPercentage: 50, penaltyTime: 60 };
              this.render();
            }
          });
          
          updateFirebaseStatus('connected', 'Connect√© ‚úì');
          this.render();
          
        } catch (error) {
          console.error('Erreur initialisation:', error);
          this.render();
          await new Promise(resolve => setTimeout(resolve, 100));
          updateFirebaseStatus('error', 'Erreur de connexion');
        }
      }
    }

    const app = new BiathonApp();
  </script>
</body>
</html>
